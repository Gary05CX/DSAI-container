FROM codercom/code-server:latest

# 更新套件
USER root
RUN apt-get update && apt-get upgrade -y

# 安裝基礎工具
RUN apt-get install -y \
    git curl wget unzip gnupg lsb-release ca-certificates software-properties-common \
    build-essential pkg-config

# Node.js + Yarn
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g yarn

# Python
RUN apt-get install -y python3 python3-pip python3-venv

# Go
RUN wget https://go.dev/dl/go1.22.2.linux-amd64.tar.gz -O /tmp/go.tar.gz && \
    tar -C /usr/local -xzf /tmp/go.tar.gz && \
    rm /tmp/go.tar.gz
ENV PATH="/usr/local/go/bin:${PATH}"

# Rust
RUN curl https://sh.rustup.rs -sSf | bash -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# C / C++
RUN apt-get install -y gcc g++ gdb cmake make

# Java (OpenJDK 17)
RUN apt-get install -y openjdk-17-jdk

# 建立工作目錄
RUN mkdir -p /home/coder/project

# 複製 init 設定 (extensions + settings)
COPY init/extensions.txt /home/coder/init/extensions.txt
COPY init/settings.json /home/coder/.local/share/code-server/User/settings.json

# 安裝 extensions
RUN cat /home/coder/init/extensions.txt | xargs -n 1 code-server --install-extension

# 調整權限
RUN chown -R coder:coder /home/coder
USER coder

WORKDIR /home/coder/project

# 啟動 code-server
CMD ["--bind-addr", "0.0.0.0:1210", "."]
